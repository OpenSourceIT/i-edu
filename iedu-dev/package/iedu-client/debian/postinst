#!/bin/bash
# postinst script
#
# see: dh_installdeb(1)

#_manupdate() {
#	mandb -f /usr/share/man/man1/hello.1.gz
#}

_updatesshd() {
  # allow only root to log into this machine via ssh
  SSHDCONFIG=/etc/ssh/sshd_config

  if [ ! -f $SSDCONFIG ]; then
     echo "$SSHDCONFIG MISSING"
     exit 1
  fi

  sed -i '1,$ s/^PermitRootLogin[^\n]*/PermitRootLogin yes/' $SSHDCONFIG

  if grep -q AllowUsers $SSHDCONFIG ; then
     sed -i '1,$ s/^AllowUsers[^\n]*/AllowUsers root/' $SSHDCONFIG
  else
     echo "AllowUsers root" >> $SSHDCONFIG
  fi

  /etc/init.d/ssh restart

}

_updatesudo() {

   SUDOC=/etc/sudoers
   if [ -f $SUDOC ]; then
      echo "modifying $SUDOC"
      mv $SUDOC ${SUDOC}.old
      cat ${SUDOC}.old | grep -v /usr/sbin/vlviewremote | grep -v /bin/login | grep -v /usr/bin/X | grep -v /usr/sbin/epoptes-client | grep -v /sbin/shutdown | grep -v "/usr/bin/killall lightdm" > $SUDOC
      echo "student ALL = NOPASSWD: /usr/sbin/vlviewremote" >> $SUDOC
      echo "student ALL = NOPASSWD: /bin/login" >> $SUDOC
      echo "student ALL = NOPASSWD: /usr/bin/X" >> $SUDOC
      echo "student ALL = NOPASSWD: /usr/sbin/epoptes-client" >> $SUDOC
      echo "student ALL = NOPASSWD: /sbin/shutdown -h now" >> $SUDOC
      echo "student ALL = NOPASSWD: /usr/bin/killall lightdm" >> $SUDOC
      chmod 0440 $SUDOC
   else
      echo "$SUDOC not found."
   fi

}

_updatestudentfromskel () {
   STUDDIR="`grep "^student" /etc/passwd | awk -F: '{print $6}'`"
   if [ "$STUDDIR" != "" -a -d "$STUDDIR" ]; then
      for dd in \
          .config \
          .i3status.conf \
          .ion3 \
          .xinitrc \
          .xserverrc \
               ; do
          cp -Rvf /etc/skel/$dd $STUDDIR
          chown -Rf student.student $STUDDIR/$dd
      done
   fi
}

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)
	echo "postinst script called with " $*

	_updatesshd
	_updatesudo
	_updatestudentfromskel

	chown root:root /etc/vlizedlab/startmenustudentgui.*

	if [ -f "/opt/puppetlabs/bin/puppet" ]; then
        echo "/opt/puppetlabs/bin/puppet agent --test" | at now +1 minutes
    fi

#	_manupdate
   ;;

    abort-upgrade|abort-remove|abort-deconfigure)
	echo "postinst script called with " $*
#	_manupdate
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0


