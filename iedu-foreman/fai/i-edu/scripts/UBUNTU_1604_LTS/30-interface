#! /bin/bash

error=0; trap 'error=$(($?>$error?$?:$error))' ERR # save maximum error code

# NICW=`/bin/ls /sys/class/net | grep -v lo | grep en | head -1`
# NICW=$(ip route | awk '/^default/ {print $5}')
NICW=`ifconfig -a | grep '^[a-z0-9]*' | grep -v lo | awk -F: '{print $1}' | head -1 | awk -F" " '{print $1}'`
	# does not work, because interface changes its name

if ifclass DHCPC && [ $FAI_ACTION = "install" ]
then
    cat > $target/etc/network/interfaces <<-EOF
	# generated by FAI
	auto lo 
	iface lo inet loopback
	# auto $NICW
	# iface $NICW inet dhcp
EOF
elif [ $FAI_ACTION = "install" ]
then
      [ -n "$IPADDR" ] && cat > $target/etc/network/interfaces <<-EOF
	# generated by FAI
	auto lo 
	# auto $NICW
	iface lo inet loopback
	# iface $NICW inet static
	#  address $IPADDR
	#  netmask $NETMASK
	#  broadcast $BROADCAST
	#  gateway $GATEWAYS
EOF
    [ -n "$NETWORK" ] && echo "localnet $NETWORK" > $target/etc/networks
    if [ ! -L $target/etc/resolv.conf -a -e /etc/resolv.conf ]; then
	cp -p /etc/resolv.conf $target/etc
    fi
fi

# here fcopy is mostly used, when installing a client for running in a
# different subnet than during the installation
fcopy -iM /etc/resolv.conf
fcopy -iM /etc/network/interfaces /etc/networks

exit $error
